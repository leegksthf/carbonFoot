var fs = require("fs");
var http = require("http");
var ejs = require("ejs");
var async = require("async");

var db = require("../../DB_config.js").connect;
var page_navi = require("../../../function/board_page_navi.js");
var layout = require("../../../function/layout.js");
var session = require("../../../function/session.js");

exports.listener=function(request, response){
	var connectorNo = session.connectorNo(request);
	var century = request.param("century")==undefined ? "" : request.param("century");

	var sql= "select a.*, date_format(a.create_date, '%Y-%m-%d') as c_date,";
		sql += " cast(if(a.sort = '', '9999999999', a.sort) as UNSIGNED) as brd_sort,";
		sql += " (select ad_nm from admin_mngt where ad_id = a.create_id) as create_name,";
		sql += " (select count(*) from board_comment c where c.board_no = a.board_no) as comment_cnt";
		sql += " from board a";
		sql += " where a.board_id = 'notice'";
		sql += " order by brd_sort, a.board_no desc LIMIT 4";

	var sql2 = "select a.*, date_format(a.create_date, '%Y-%m-%d') as c_date,";
		sql2 +=" cast(if(a.sort = '', '9999999999', a.sort) as UNSIGNED) as brd_sort,";
		sql2 +=" (select ad_nm from admin_mngt where ad_id = a.create_id) as create_name, ";
		sql2 +=" ifnull((select c.file_dtname from gallery_files c where c.board_no = a.board_no and c.file_type='main'), '') as img_file_name, ";
		sql2 +=" ifnull(b.orgmem_name, '') as orgmem_name, ";
		sql2 +=" (select count(*) from gallery_board_comment c where c.board_no = a.board_no) as comment_cnt";
		sql2 +=" from gallery_board a left outer join orgmember b on a.orgmem_no = b.orgmem_no ";
		sql2 += " where a.board_id = 'gallery'";
		sql2 += " order by brd_sort, a.board_no desc LIMIT 3";
	

	var sql3 = "select a.*, date_format(a.create_date, '%Y-%m-%d') as c_date,";
		sql3 +=" cast(if(a.sort = '', '9999999999', a.sort) as UNSIGNED) as brd_sort,";
		sql3 +=" a.create_id as create_name,";
		sql3 +=" (select count(*) from event_board_comment c where c.board_no = a.board_no) as comment_cnt,";
		sql3 +=" (select file_dtname from event_files D where D.board_no = a.board_no limit 0, 1) as file_dtname,";			
		sql3 +=" date_format(board_startdate, '%Y.%m.%d') as board_startdate_nm,";
		sql3 +=" date_format(board_enddate, '%Y.%m.%d') as board_enddate_nm,";
		sql3 +=" date_format(board_eventsdate, '%Y.%m.%d') as board_eventsdate_nm,";
		sql3 +=" date_format(board_eventedate, '%Y.%m.%d') as board_eventedate_nm,";
		sql3 +=" case WEEKDAY(board_startdate)";
		sql3 +=" when '0' then '월'";
		sql3 +=" when '1' then '화'";
		sql3 +=" when '2' then '수'";
		sql3 +=" when '3' then '목'";
		sql3 +=" when '4' then '금'";
		sql3 +=" when '5' then '토'";
		sql3 +=" when '6' then '일'";
		sql3 +=" end as bs_week_name,";
		sql3 +=" case WEEKDAY(board_enddate)";
		sql3 +=" when '0' then '월'";
		sql3 +=" when '1' then '화'";
		sql3 +=" when '2' then '수'";
		sql3 +=" when '3' then '목'";
		sql3 +=" when '4' then '금'";
		sql3 +=" when '5' then '토'";
		sql3 +=" when '6' then '일'";
		sql3 +=" end as be_week_name,";
		sql3 +=" case WEEKDAY(board_eventsdate)";
		sql3 +=" when '0' then '월'";
		sql3 +=" when '1' then '화'";
		sql3 +=" when '2' then '수'";
		sql3 +=" when '3' then '목'";
		sql3 +=" when '4' then '금'";
		sql3 +=" when '5' then '토'";
		sql3 +=" when '6' then '일'";
		sql3 +=" end as es_week_name,";
		sql3 +=" case WEEKDAY(board_eventedate)";
		sql3 +=" when '0' then '월'";
		sql3 +=" when '1' then '화'";
		sql3 +=" when '2' then '수'";
		sql3 +=" when '3' then '목'";
		sql3 +=" when '4' then '금'";
		sql3 +=" when '5' then '토'";
		sql3 +=" when '6' then '일'";
		sql3 +=" end as ee_week_name,";
		sql3 +="(SELECT COUNT(*) FROM event_request b WHERE a.board_no = b.board_no AND b.request_state = 'y') AS y_cnt,";
		sql3 +="(SELECT COUNT(*) FROM event_request b WHERE a.board_no = b.board_no AND b.request_state = 'n') AS n_cnt,";
		sql3 +="(SELECT COUNT(*) FROM event_request b WHERE a.board_no = b.board_no AND b.request_state = 'i') AS i_cnt";
		sql3 +=" from event_board a";
		sql3 += " where a.board_id = 'event'";
		sql3 += " order by brd_sort, a.board_no desc LIMIT 1";


		var sql4 = "select a.*, date_format(a.create_date, '%Y-%m-%d') as c_date,";
		sql4 +=" cast(if(a.sort = '', '9999999999', a.sort) as UNSIGNED) as brd_sort,";
		sql4 +=" (select ad_nm from admin_mngt where ad_id = a.create_id) as create_name, ";
		sql4 +=" ifnull((select c.file_dtname from hongbo_files c where c.board_no = a.board_no and c.file_type='main'), '') as img_file_name, ";
		sql4 +=" ifnull(b.orgmem_name, '') as orgmem_name, ";
		sql4 +=" (select count(*) from hongbo_board_comment c where c.board_no = a.board_no) as comment_cnt";
		sql4 +=" from hongbo_board a left outer join orgmember b on a.orgmem_no = b.orgmem_no ";
		sql4 += " where a.board_id = 'hongbo'";
		sql4 += " order by rand()";


		console.log(sql)
		console.log(sql2)
		console.log(sql3)
		console.log(sql4)

	fs.readFile("./views/user/community/community.html", "utf-8", function(error, data){
		db.query(sql, function(error, board_results){	
			db.query(sql2, function(error, gallery_results){			
				db.query(sql3, function(error, event_results){	
					db.query(sql4, function(error, hongbo_results){
			response.send(ejs.render(layout.include("app_user", data), {
				connectorNo : connectorNo,
				century:century,
				menuNum:3,
				board_results:board_results,
				gallery_results:gallery_results,
				event_results:event_results,
				hongbo_results:hongbo_results
			})); 
		});
	});
});
	}); 
}); 
};
